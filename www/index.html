<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src * data: gap: content: https://ssl.gstatic.com; style-src * 'unsafe-inline'; script-src * 'unsafe-inline' 'unsafe-eval'">
    <script src="cordova.js"></script>
    <script src="components/loader.js"></script>
    <link rel="stylesheet" href="components/loader.css">
    <link rel="stylesheet" href="css/style.css">

    <!-- Firebase SDKã®èª­ã¿è¾¼ã¿ -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="www/config.js"></script>

    <script>
let postsRef;
let postsListener = null;

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºå‡¦ç†
function showMessage(message, type = 'success') {
    const messageArea = $('#messageArea');
    messageArea.html(`
        <div class="message ${type}">
            ${message}
        </div>
    `);

    // 3ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¶ˆã™
    setTimeout(() => {
        messageArea.empty();
    }, 3000);
}

// æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆã®æ›´æ–°
function updateCharacterCount(inputId, counterId, maxLength) {
    const input = $(`#${inputId}`);
    const counter = $(`#${counterId}`);

    input.on('input', () => {
        const length = input.val().length;
        counter.text(`${length}/${maxLength}`);

        if (length > maxLength) {
            counter.addClass('error');
        } else {
            counter.removeClass('error');
        }
    });
}

// å…¥åŠ›å€¤ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
function validateInput(author, content) {
    if (!author.trim()) {
        showMessage('ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return false;
    }
    if (author.length > 20) {
        showMessage('ãŠåå‰ã¯20æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return false;
    }
    return validateContent(content);
}

// æŠ•ç¨¿å†…å®¹ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
function validateContent(content) {
    if (!content || !content.trim()) {
        showMessage('æŠ•ç¨¿å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return false;
    }
    if (content.length > 1000) {
        showMessage('æŠ•ç¨¿å†…å®¹ã¯1000æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return false;
    }
    return true;
}

// æŠ•ç¨¿å‡¦ç†
function createPost(author, content) {
    if (!validateInput(author, content)) return;

    const button = $('#postButton');
    button.prop('disabled', true);

    const postData = {
        author: author,
        content: content,
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };

    postsRef.push(postData)
    .then(() => {
        showMessage('æŠ•ç¨¿ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
        $('#authorInput').val('');
        $('#contentInput').val('');
        updateCharacterCount('authorInput', 'authorCount', 20);
        updateCharacterCount('contentInput', 'contentCount', 1000);
    })
    .catch((error) => {
        showMessage('æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + error.message, 'error');
    })
    .finally(() => {
        button.prop('disabled', false);
    });
}

// HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†
function escapeHtml(str) {
    if (!str) return '';
    return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}

// ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
function formatTimestamp(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// æŠ•ç¨¿ã®HTMLè¦ç´ ã‚’ç”Ÿæˆ
function createPostElement(post) {
    return `
        <div class="post" id="post-${post.id}">
            <div class="post-header">
                <span class="post-author">${escapeHtml(post.author)}</span>
                <div class="post-actions">
                    <button class="btn-edit" onclick="startEdit('${post.id}')">
                        ç·¨é›†
                    </button>
                    <button class="btn-delete" onclick="deletePost('${post.id}')">
                        å‰Šé™¤
                    </button>
                </div>
            </div>
            <div class="post-content">${escapeHtml(post.content)}</div>
            <div class="edit-form">
                <textarea class="form-control" id="edit-${post.id}"></textarea>
                <div class="button-group">
                    <button class="btn-primary" onclick="updatePost('${post.id}')">
                        æ›´æ–°
                    </button>
                    <button class="btn-cancel" onclick="cancelEdit('${post.id}')">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                </div>
            </div>
            <div class="post-footer">
                <span class="post-time">
                    ${formatTimestamp(post.timestamp)}
                </span>
                ${post.updatedAt ? `
                    <span class="post-updated">
                        (ç·¨é›†æ¸ˆã¿: ${formatTimestamp(post.updatedAt)})
                    </span>
                ` : ''}
            </div>
        </div>
    `;
}

// æŠ•ç¨¿ã®è¡¨ç¤ºå‡¦ç†
function renderPosts(posts) {
    const postsDiv = $('#postsList');
    postsDiv.empty();

    // æŠ•ç¨¿æ•°ã‚’æ›´æ–°
    $('#postsCount').text(`æŠ•ç¨¿æ•°: ${posts.length}ä»¶`);

    if (posts.length === 0) {
        postsDiv.html('<p class="no-posts">æŠ•ç¨¿ã¯ã‚ã‚Šã¾ã›ã‚“</p>');
        return;
    }

    posts.forEach((post) => {
        postsDiv.append(createPostElement(post));
    });
}

// æŠ•ç¨¿ã®èª­ã¿è¾¼ã¿
function loadPosts() {
    const sortOrder = $('#sortOrder').val();
    $('#loadingSpinner').show();

    // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤
    if (postsListener) {
        postsRef.off('value', postsListener);
        postsListener = null;
    }

    // ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    postsListener = postsRef.on('value', (snapshot) => {
        const posts = [];
        snapshot.forEach((childSnapshot) => {
            posts.push({
                id: childSnapshot.key,
                ...childSnapshot.val()
            });
        });

        // ä¸¦ã³é †ã®é©ç”¨
        if (sortOrder === 'newest') {
            posts.sort((a, b) => b.timestamp - a.timestamp);
        } else {
            posts.sort((a, b) => a.timestamp - b.timestamp);
        }

        renderPosts(posts);
        $('#loadingSpinner').hide();
    }, (error) => {
        console.error('Data fetch error:', error);
        showMessage('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        $('#loadingSpinner').hide();
    });
}

// ç·¨é›†ã®é–‹å§‹
function startEdit(postId) {
    const postElement = $(`#post-${postId}`);
    const content = postElement.find('.post-content').text();
    postElement.find('textarea').val(content);
    postElement.addClass('editing');
}

// ç·¨é›†ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«
function cancelEdit(postId) {
    const postElement = $(`#post-${postId}`);
    postElement.removeClass('editing');
    postElement.find('textarea').val('');
}

// æŠ•ç¨¿ã®æ›´æ–°
function updatePost(postId) {
    const contentVal = $(`#edit-${postId}`).val();
    if (!validateContent(contentVal)) return;

    // content ã®å†…å®¹ã‚’å¤‰æ›´ã—ã€updatedAt ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä»˜åŠ ã—ã¦ã€æ›´æ–°å¾Œã®æŠ•ç¨¿å†…å®¹ã‚’ç”Ÿæˆ
    const updates = {
        content: contentVal,
        updatedAt: firebase.database.ServerValue.TIMESTAMP
    };

    postsRef.child(postId).update(updates)
    .then(() => {
        showMessage('æŠ•ç¨¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
        $(`#post-${postId}`).removeClass('editing');
        animateUpdate(postId);
    })
    .catch((error) => {
        showMessage('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + error.message, 'error');
    });
}

// æŠ•ç¨¿ã®å‰Šé™¤
function deletePost(postId) {
    if (!confirm('ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
        return;
    }

    const postElement = $(`#post-${postId}`);
    postElement.addClass('deleting');

   postsRef.child(postId).remove()
    .then(() => {
        showMessage('æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    })
    .catch((error) => {
        showMessage('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + error.message, 'error');
        postElement.removeClass('deleting');
    });
}

// æ›´æ–°æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
function animateUpdate(postId) {
    const post = $(`#post-${postId}`);
    post.addClass('updated');
    setTimeout(() => {
        post.removeClass('updated');
    }, 1000);
}

$(function() {
    // Firebaseã®åˆæœŸåŒ–
    try {
        firebase.initializeApp(firebaseConfig);
        console.log("Firebase initialized successfully");
        postsRef = firebase.database().ref('posts');
    } catch (error) {
        console.error("Firebase initialization error:", error);
        showMessage('Firebaseã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }

    // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®åˆæœŸåŒ–
    updateCharacterCount('authorInput', 'authorCount', 20);
    updateCharacterCount('contentInput', 'contentCount', 1000);

    // æŠ•ç¨¿å‡¦ç†
    $('#postButton').on('click', () => {
        // æŠ•ç¨¿å†…å®¹ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰å–å¾—
        const authorVal = $('#authorInput').val();
        const contentVal = $('#contentInput').val();
        createPost(authorVal, contentVal);
    });

    // æŠ•ç¨¿ä¸€è¦§è¡¨ç¤ºé †åºé¸æŠ
    $('#sortOrder').on('change', loadPosts);

       // æ›´æ–°ãƒœã‚¿ãƒ³
    $('#refreshButton').on('click', () => {
        loadPosts();
        showMessage('æŠ•ç¨¿ä¸€è¦§ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
    });

    
    // æŠ•ç¨¿ä¸€è¦§ã®åˆæœŸèª­ã¿è¾¼ã¿
    loadPosts();
});

// ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†
window.addEventListener('unload', function() {
    if (postsListener) {
        postsRef.off('value', postsListener);
        postsListener = null;
    }
});
    </script>
</head>
<body>
    <div class="container">
        <h1>æ²ç¤ºæ¿ã‚¢ãƒ—ãƒª</h1>

        <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="messageArea"></div>

        <!-- æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="post-form">
            <div class="form-group">
                <label for="authorInput">ãŠåå‰</label>
                <input type="text" id="authorInput"
                       class="form-control" placeholder="ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
                <small class="character-count" id="authorCount">0/20</small>
            </div>
            <div class="form-group">
                <label for="contentInput">æŠ•ç¨¿å†…å®¹</label>
                <textarea id="contentInput" class="form-control"
                          placeholder="æŠ•ç¨¿å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
                <small class="character-count" id="contentCount">0/1000</small>
            </div>
            <div class="button-group">
                <button id="postButton" class="btn-primary">æŠ•ç¨¿ã™ã‚‹</button>
            </div>
        </div>

        <!-- æŠ•ç¨¿ä¸€è¦§ -->
        <div class="posts-container">
                        <div class="posts-header">
                <h2>æŠ•ç¨¿ä¸€è¦§</h2>
                <span id="postsCount" class="posts-count">æŠ•ç¨¿æ•°: 0ä»¶</span>
            </div>
            <div class="posts-control">
                <select id="sortOrder" class="form-control">
                    <option value="newest">æ–°ã—ã„é †</option>
                    <option value="oldest">å¤ã„é †</option>
                </select>
                               <button id="refreshButton" class="btn-refresh" title="æ›´æ–°">
                    ğŸ”„ æ›´æ–°
                </button>
            </div>
            <div id="postsList"></div>
            <div id="loadingSpinner" class="loading-spinner" style="display: none;">
                <div class="spinner"></div>
                <p>èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </div>
    </div>
</body>
</html>
